#!/bin/bash

# ================= é…ç½® =================
GM_DIR="$HOME/.local/share/qutebrowser/greasemonkey"
DISABLED_DIR="$GM_DIR/disabled"
MAP_FILE="$GM_DIR/.url_map"

mkdir -p "$GM_DIR"
mkdir -p "$DISABLED_DIR"
touch "$MAP_FILE"

# å¯ç”¨åˆ—è¡¨ & ç¦ç”¨åˆ—è¡¨
LIST_ENABLED="$QB_GM_LIST"
LIST_DISABLED="$QB_GM_DISABLED_LIST"

# è·å–ä»£ç†
PROXY_CMD=""
if [ -n "$QB_PROXY" ]; then
    PROXY_CMD="-x $QB_PROXY"
fi

# ================= å·¥å…·å‡½æ•° =================

msg() {
    local text="$1"
    if [ -n "$QUTE_FIFO" ]; then
        echo "message-info \"$text\"" > "$QUTE_FIFO"
    else
        echo ">> $text"
    fi
}

# è·å–çœŸå®çš„ä¸‹è½½é“¾æ¥
get_dl_url_and_id() {
    local url="$1"
    local dl_url="$url"
    local id=""

    # é€»è¾‘ï¼šå¦‚æœæ˜¯ GreasyForkï¼Œæå– ID å¹¶æ„é€ ä¸‹è½½é“¾
    if [[ "$url" == *"greasyfork.org"* ]] && [[ "$url" != *".js" ]]; then
        id=$(echo "$url" | grep -oE "/scripts/[0-9]+" | cut -d/ -f3)
        if [ -n "$id" ]; then
            dl_url="https://update.greasyfork.org/scripts/${id}/code.user.js"
        fi
    fi

    # å¦‚æœæ²¡æœ‰æå–åˆ° ID (ç›´é“¾æƒ…å†µ)ï¼Œè®¡ç®— URL çš„ md5 ä½œä¸º IDï¼Œé˜²æ­¢åŒåå†²çª
    if [ -z "$id" ]; then
        id=$(echo "$url" | md5sum | cut -c1-8)
    fi

    # è¾“å‡ºä»¥ç®¡é“ç¬¦åˆ†éš”: URL|ID
    echo "$dl_url|$id"
}

# ä»æ–‡ä»¶å†…å®¹æå– @name
extract_name() {
    local file="$1"
    local name=""
    # ä¼˜å…ˆä¸­æ–‡å > è‹±æ–‡å
    name=$(grep -m1 "^// @name:zh-CN" "$file" | sed 's|^// @name:zh-CN[[:space:]]*||')
    [ -z "$name" ] && name=$(grep -m1 "^// @name:zh" "$file" | sed 's|^// @name:zh[[:space:]]*||')
    [ -z "$name" ] && name=$(grep -m1 "^// @name" "$file" | sed 's|^// @name[[:space:]]*||')
    
    # å‡€åŒ–æ–‡ä»¶å (ç©ºæ ¼è½¬ä¸‹åˆ’çº¿ï¼Œå»æ–œæ )
    echo "$name" | tr -d '\r' | tr '/' '_' | xargs | tr ' ' '_'
}

# æŸ¥ç¼“å­˜ï¼šæ ¹æ® URL è·å–æœ¬åœ°æ–‡ä»¶å
get_filename_from_map() {
    # ç²¾ç¡®åŒ¹é…ï¼Œé˜²æ­¢å­ä¸²è¯¯åˆ¤
    grep -F "$1 " "$MAP_FILE" | head -n 1 | awk '{print $2}'
}

# æ›´æ–°ç¼“å­˜
update_map() {
    local url="$1"
    local filename="$2"
    # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶åŸå­æ›´æ–°
    grep -vF "$url " "$MAP_FILE" > "${MAP_FILE}.tmp"
    echo "$url $filename" >> "${MAP_FILE}.tmp"
    mv "${MAP_FILE}.tmp" "$MAP_FILE"
}

# ================= æ ¸å¿ƒå¤„ç†é€»è¾‘ =================

process_script() {
    local raw_url="$1"
    local is_disabled="$2" # "true" or "false"

    # 1. è·å–ä¸‹è½½é“¾æ¥å’ŒID
    local info=$(get_dl_url_and_id "$raw_url")
    local dl_url="${info%|*}"
    local id="${info#*|}"

    # 2. æŸ¥ç¼“å­˜æ–‡ä»¶å
    local filename=$(get_filename_from_map "$raw_url")
    
    # è·¯å¾„å®šä¹‰
    local file_path=""
    local disabled_path=""
    
    # 3. åˆå§‹åŒ–åˆ†æ”¯ï¼šç¼“å­˜æ— è®°å½• æˆ– æ–‡ä»¶å®ä½“ä¸¢å¤± -> å¿…é¡»é‡æ–°ä¸‹è½½
    if [ -z "$filename" ] || ([ ! -f "$GM_DIR/$filename" ] && [ ! -f "$DISABLED_DIR/$filename" ]); then
        if [ -z "$QUTE_FIFO" ]; then echo "ğŸ” Init: $raw_url"; fi
        
        local temp_dl=$(mktemp)
        # ç¬¬ä¸€æ¬¡ä¸‹è½½ä¸ä½¿ç”¨ -zï¼Œå¿…é¡»å…¨é‡
        curl $PROXY_CMD -sL "$dl_url" -o "$temp_dl"
        
        # æ ¡éªŒæ–‡ä»¶æœ‰æ•ˆæ€§
        if [ $? -ne 0 ] || ! grep -q "==UserScript==" "$temp_dl"; then
            msg "âŒ ä¸‹è½½æ— æ•ˆ: $raw_url"
            rm "$temp_dl"
            return
        fi
        
        # æå–åç§°å¹¶ç»„åˆ ID
        local script_name=$(extract_name "$temp_dl")
        [ -z "$script_name" ] && script_name="script"
        
        # æ ¼å¼: ID_è„šæœ¬å.user.js (è§£å†³åŒåå†²çª)
        filename="${id}_${script_name}.user.js"
        
        # å­˜å…¥ç¼“å­˜
        update_map "$raw_url" "$filename"
        
        # æ”¾å…¥å¯ç”¨ç›®å½•
        mv "$temp_dl" "$GM_DIR/$filename"
        msg "ğŸ†• æ–°å¢: $script_name"
    fi

    # æ­¤æ—¶ filename å¿…ç„¶å­˜åœ¨ä¸”æ­£ç¡®
    file_path="$GM_DIR/$filename"
    disabled_path="$DISABLED_DIR/$filename"

    # --- é€»è¾‘åˆ†æ”¯ A: ç¦ç”¨ ---
    if [ "$is_disabled" = "true" ]; then
        # å¦‚æœåœ¨å¯ç”¨ç›®å½•ï¼Œç§»èµ°
        if [ -f "$file_path" ]; then
            mv "$file_path" "$disabled_path"
            msg "ğŸ’¤ ç¦ç”¨: $filename"
        fi
        return
    fi

    # --- é€»è¾‘åˆ†æ”¯ B: å¯ç”¨/æ›´æ–° ---
    
    # 1. å¤æ´»æ£€æµ‹
    if [ -f "$disabled_path" ]; then
        mv "$disabled_path" "$file_path"
        msg "â™»ï¸ å¯ç”¨: $filename"
    fi
    
    # 2. å¢é‡æ›´æ–° (Time Conditional)
    # åªæœ‰å½“ file_path å­˜åœ¨æ—¶ï¼Œ-z æ‰æœ‰æ„ä¹‰
    local http_code
    if [ -f "$file_path" ]; then
        # -z: åªæœ‰æ¯”æœ¬åœ°æ–‡ä»¶æ–°æ‰ä¸‹è½½
        http_code=$(curl $PROXY_CMD -L -R -z "$file_path" -o "$file_path" -w "%{http_code}" -s "$dl_url")
    else
        # æ–‡ä»¶å¼‚å¸¸ä¸¢å¤±ï¼Œå…¨é‡ä¸‹è½½
        http_code=$(curl $PROXY_CMD -L -o "$file_path" -w "%{http_code}" -s "$dl_url")
    fi

    if [ "$http_code" == "200" ]; then
        msg "âœ… æ›´æ–°: $filename"
    elif [ "$http_code" == "404" ]; then
        msg "âŒ è¿œç¨‹404: $filename"
    elif [ "$http_code" != "304" ] && [ "$http_code" != "000" ]; then
        msg "âŒ é”™è¯¯($http_code): $filename"
    fi
}

# ================= æ‰§è¡Œå…¥å£ =================

if [ -z "$LIST_ENABLED" ] && [ -z "$LIST_DISABLED" ]; then
    msg "âš ï¸ åˆ—è¡¨ä¸ºç©º"
    exit 0
fi

msg "ğŸš€ è„šæœ¬åŒæ­¥ä¸­... (Proxy: ${QB_PROXY:-OFF})"

# 1. å†²çªæ£€æµ‹
# --------------------
# æ‰¾å‡ºåŒæ—¶å­˜åœ¨äºä¸¤ä¸ªåˆ—è¡¨çš„ URL
CONFLICTS=$(comm -12 <(echo "$LIST_ENABLED" | tr ' ' '\n' | sort) <(echo "$LIST_DISABLED" | tr ' ' '\n' | sort))
for url in $CONFLICTS; do
    if [ -n "$url" ]; then
        msg "ğŸ›‘ è·³è¿‡ $url "
    fi
msg "ä»¥ä¸Š url ç¦ç”¨åˆ—è¡¨å’Œå¯ç”¨åˆ—è¡¨éƒ½å­˜åœ¨"
done

# 2. å¤„ç†åˆ—è¡¨
# --------------------
# ä»…å¤„ç†éå†²çªé¡¹
for url in $LIST_ENABLED; do
    # å¦‚æœ url åœ¨å†²çªåˆ—è¡¨ä¸­ï¼Œè·³è¿‡
    if echo "$CONFLICTS" | grep -qF "$url"; then continue; fi
    process_script "$url" "false"
done

for url in $LIST_DISABLED; do
    if echo "$CONFLICTS" | grep -qF "$url"; then continue; fi
    process_script "$url" "true"
done

# 3. æ¸…ç†åºŸå¼ƒè„šæœ¬
# --------------------
# éå† .url_map é‡Œçš„æ¯ä¸€è¡Œã€‚
# å¦‚æœè¯¥è¡Œçš„ URL ä¸åœ¨ LIST_ENABLED ä¹Ÿä¸åœ¨ LIST_DISABLED ä¸­ï¼Œåˆ™è§†ä¸ºåºŸå¼ƒã€‚
# --------------------

# åˆ›å»ºä¸´æ—¶æ˜ å°„æ–‡ä»¶ç”¨äºæ›´æ–°
NEW_MAP=$(mktemp)

while read -r line; do
    [ -z "$line" ] && continue
    url=$(echo "$line" | awk '{print $1}')
    file=$(echo "$line" | awk '{print $2}')
    
    # æ£€æŸ¥ URL æ˜¯å¦å­˜åœ¨äºå½“å‰çš„é…ç½®åˆ—è¡¨ä¸­
    # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç²¾ç¡®åŒ¹é…
    is_active=0
    # æ£€æŸ¥å¯ç”¨åˆ—è¡¨
    if echo " $LIST_ENABLED " | grep -q " $url "; then is_active=1; fi
    # æ£€æŸ¥ç¦ç”¨åˆ—è¡¨
    if echo " $LIST_DISABLED " | grep -q " $url "; then is_active=1; fi

    if [ $is_active -eq 1 ]; then
        # æœ‰æ•ˆï¼Œä¿ç•™åœ¨ map ä¸­
        echo "$line" >> "$NEW_MAP"
    else
        # æ— æ•ˆï¼Œæ‰§è¡Œåˆ é™¤
        if [ -f "$GM_DIR/$file" ]; then
            rm "$GM_DIR/$file"
            msg "ğŸ—‘ï¸ åˆ é™¤: $file"
        fi
        if [ -f "$DISABLED_DIR/$file" ]; then
            rm "$DISABLED_DIR/$file"
            msg "ğŸ—‘ï¸ åˆ é™¤: $file"
        fi
    fi
done < "$MAP_FILE"

mv "$NEW_MAP" "$MAP_FILE"

# ================= æ”¶å°¾ =================
if [ -n "$QUTE_FIFO" ]; then
    echo "greasemonkey-reload" > "$QUTE_FIFO"
    msg "âœ… å®Œæˆ (å·²é‡è½½)"
else
    echo "âœ… å®Œæˆ"
fi
